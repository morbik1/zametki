<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏ ‚Äî v3.0</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    :root{
      --toolbar-height: 72px;
    }
    @keyframes fadeIn { 0%{opacity:0;transform:scale(.9) translateY(18px)}100%{opacity:1;transform:none} }
    @keyframes fadeOut { 0%{opacity:1}100%{opacity:0;transform:scale(.9) translateY(18px)} }
    .note{ position:absolute; min-width:200px; min-height:120px; resize:both; overflow:auto; animation:fadeIn .28s ease forwards; }
    .note-header{ background:rgba(0,0,0,0.06); padding:6px; cursor:grab; display:flex; gap:.5rem; align-items:center; justify-content:space-between; border-bottom:1px solid rgba(0,0,0,0.08); }
    .note textarea{ width:100%; height:calc(100% - 42px); resize:none; outline:none; background:transparent; padding:8px; font-size:14px; }
    .pinned{ box-shadow:0 0 15px rgba(239,68,68,0.5) !important; }
    .fade-out{ animation:fadeOut .28s ease forwards; }
    /* Dark theme overrides */
    .dark body { background: linear-gradient(135deg,#0f172a,#0b1220) !important; }
    .dark .toolbar { background: linear-gradient(90deg,#0f172a,#001219); color:#e6eef8; }
    .dark .page-ind { background:#0b1220; color:#e6eef8; box-shadow:0 6px 18px rgba(0,0,0,0.6); }
    .hidden { display:none !important; }
  </style>
</head>
<body class="bg-gradient-to-br from-blue-100 via-purple-100 to-pink-100 h-screen overflow-hidden">

  <!-- Toolbar -->
  <div id="toolbar" class="toolbar bg-gradient-to-r from-blue-500 to-purple-500 text-white px-6 py-4 flex items-center justify-between shadow-lg">
    <div class="flex items-center gap-4">
      <h1 class="text-2xl font-bold">üìù –ú–æ–∏ –∑–∞–º–µ—Ç–∫–∏</h1>
      <input id="search" type="search" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∑–∞–º–µ—Ç–∫–∞–º..." class="rounded-lg px-3 py-1 outline-none" />
    </div>

    <div class="flex items-center gap-2">
      <button id="themeToggle" class="bg-white text-gray-800 px-3 py-1 rounded-lg shadow">–¢–µ–º–∞</button>
      <label class="flex items-center gap-2 bg-white px-3 py-1 rounded-lg shadow cursor-pointer">
        <input id="exportBtn" type="button" value="–≠–∫—Å–ø–æ—Ä—Ç" class="hidden"/>
        <span id="exportVisible" class="text-gray-800 select-none">–≠–∫—Å–ø–æ—Ä—Ç</span>
      </label>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button id="importBtn" class="bg-white text-gray-800 px-3 py-1 rounded-lg shadow">–ò–º–ø–æ—Ä—Ç</button>

      <button id="prevPage" class="bg-white text-blue-600 font-semibold px-3 py-1 rounded-xl shadow hover:bg-gray-100">‚¨Ö</button>
      <button id="nextPage" class="bg-white text-blue-600 font-semibold px-3 py-1 rounded-xl shadow hover:bg-gray-100">‚û°</button>
      <button id="addNote" class="bg-white text-blue-600 font-semibold px-4 py-2 rounded-xl shadow-md hover:bg-gray-100">+ –ó–∞–º–µ—Ç–∫–∞</button>
    </div>
  </div>

  <!-- Page indicator -->
  <div id="pageIndicator" class="page-ind fixed bottom-4 left-1/2 -translate-x-1/2 bg-white px-4 py-2 rounded-lg shadow-md font-semibold text-gray-700"></div>

  <!-- transient message -->
  <div id="messageBox" class="fixed top-4 left-1/2 -translate-x-1/2 bg-red-500 text-white px-4 py-2 rounded-lg shadow-md hidden"></div>

<script>
/* ============================
   –£—Ç–∏–ª–∏—Ç—ã: base64 (utf8-safe)
   ============================ */
function toBase64Unicode(obj){
  const s = JSON.stringify(obj);
  // utf8-safe base64
  return btoa(encodeURIComponent(s).replace(/%([0-9A-F]{2})/g, (m,p)=> String.fromCharCode('0x'+p)));
}
function fromBase64Unicode(b64){
  try{
    const str = decodeURIComponent(Array.prototype.map.call(atob(b64), c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join(''));
    return JSON.parse(str);
  }catch(e){ return null; }
}

/* ============================
   Storage wrapper (base64)
   ============================ */
const STORAGE_KEY = "notesApp_b64_v3";
function loadData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return { pages:[[]], currentPage:0 };
  const decoded = fromBase64Unicode(raw);
  if(decoded) return decoded;
  // fallback: maybe stored plain JSON under older key
  try {
    const alt = JSON.parse(localStorage.getItem("notesApp") || "{}");
    if(alt && alt.pages) return alt;
  } catch(e) {}
  return { pages:[[]], currentPage:0 };
}
function saveData(obj){
  try{
    localStorage.setItem(STORAGE_KEY, toBase64Unicode(obj));
  }catch(e){
    showMessage("–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∏–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ");
  }
}

/* ============================
   App state
   ============================ */
const toolbarHeight = document.getElementById('toolbar').offsetHeight;
let data = loadData();

/* show/hide message */
function showMessage(text, time=3000){
  const box = document.getElementById('messageBox');
  box.textContent = text;
  box.classList.remove('hidden');
  clearTimeout(box._t);
  box._t = setTimeout(()=> box.classList.add('hidden'), time);
}

/* ============================
   Create note DOM
   ============================ */
function createNoteElement(note){
  const div = document.createElement('div');
  div.className = 'note rounded-xl shadow-xl';
  if(note.pinned) div.classList.add('pinned');
  // position/size
  div.style.left = (note.x ?? 120) + 'px';
  div.style.top = (note.y ?? (toolbarHeight + 20)) + 'px';
  div.style.width = (note.width ?? 220) + 'px';
  div.style.height = (note.height ?? 140) + 'px';

  // header
  const header = document.createElement('div');
  header.className = 'note-header';

  const leftBtns = document.createElement('div');
  leftBtns.className = 'flex items-center gap-2';

  // pin
  const pin = document.createElement('button');
  pin.textContent = note.pinned ? 'üìå' : 'üìç';
  pin.title = '–ó–∞–∫—Ä–µ–ø–∏—Ç—å/–æ—Ç–∫—Ä–µ–ø–∏—Ç—å';
  pin.onclick = (e)=>{ e.stopPropagation(); note.pinned = !note.pinned; saveAndRender(); };

  // color cycle
  const colorBtn = document.createElement('button');
  colorBtn.textContent = 'üé®';
  colorBtn.title = '–°–º–µ–Ω–∏—Ç—å —Ü–≤–µ—Ç';
  colorBtn.onclick = (e)=>{ e.stopPropagation(); const colors = ['bg-yellow-100','bg-green-100','bg-pink-100','bg-blue-100','bg-purple-100']; let i = colors.indexOf(note.color || 'bg-yellow-100'); note.color = colors[(i+1)%colors.length]; saveAndRender(); };

  leftBtns.append(pin, colorBtn);

  const rightBtns = document.createElement('div');
  rightBtns.className = 'flex items-center gap-2';

  // copy
  const copyBtn = document.createElement('button');
  copyBtn.textContent = 'üìã';
  copyBtn.title = '–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç';
  copyBtn.onclick = async (e)=>{ e.stopPropagation(); try{ await navigator.clipboard.writeText(note.text || ''); showMessage('–¢–µ–∫—Å—Ç —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω'); }catch(err){ showMessage('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è'); } };

  // delete
  const delBtn = document.createElement('button');
  delBtn.textContent = '‚ùå';
  delBtn.title = '–£–¥–∞–ª–∏—Ç—å –∑–∞–º–µ—Ç–∫—É';
  delBtn.onclick = (e)=>{ e.stopPropagation(); const page = data.pages[data.currentPage]; data.pages[data.currentPage] = page.filter(n => n !== note); saveAndRender(); };

  rightBtns.append(copyBtn, delBtn);

  header.appendChild(leftBtns);
  header.appendChild(rightBtns);

  // textarea
  const ta = document.createElement('textarea');
  ta.value = note.text || '';
  ta.placeholder = '–¢–µ–∫—Å—Ç –∑–∞–º–µ—Ç–∫–∏...';
  ta.oninput = ()=>{ note.text = ta.value; saveData(data); };

  // apply color class
  div.classList.add(note.color || 'bg-yellow-100');

  div.appendChild(header);
  div.appendChild(ta);

  // drag (only on header)
  let isDragging=false, offX=0, offY=0;
  header.addEventListener('mousedown',(e)=>{
    if(note.pinned) return;
    isDragging=true; offX = e.clientX - div.offsetLeft; offY = e.clientY - div.offsetTop; header.style.cursor='grabbing';
    function onMove(ev){ if(!isDragging) return; let nx = ev.clientX - offX, ny = ev.clientY - offY; if(ny < toolbarHeight) ny = toolbarHeight; div.style.left = nx+'px'; div.style.top = ny+'px'; }
    function onUp(){ if(isDragging){ note.x = div.offsetLeft; note.y = div.offsetTop; saveData(data); } isDragging=false; header.style.cursor='grab'; document.removeEventListener('mousemove',onMove); document.removeEventListener('mouseup',onUp); }
    document.addEventListener('mousemove', onMove);
    document.addEventListener('mouseup', onUp);
  });

  // resize observe
  const ro = new ResizeObserver(()=>{ note.width = div.offsetWidth; note.height = div.offsetHeight; saveData(data); });
  ro.observe(div);

  return div;
}

/* ============================
   Render (with optional search)
   ============================ */
function render(searchText = ''){
  // remove old
  document.querySelectorAll('.note').forEach(n => n.remove());
  const notes = data.pages[data.currentPage] || [];
  const filtered = notes.filter(n => {
    if(!searchText) return true;
    const s = (n.text || '') + ' ' + (n.tags || []).join(' ');
    return s.toLowerCase().includes(searchText.toLowerCase());
  });
  filtered.forEach(n => {
    document.body.appendChild(createNoteElement(n));
  });
  document.getElementById('pageIndicator').textContent = `–°—Ç—Ä–∞–Ω–∏—Ü–∞ ${data.currentPage+1} / ${data.pages.length}`;
}

/* ============================
   Helpers: save & render
   ============================ */
function saveAndRender(){ saveData(data); render(document.getElementById('search').value.trim()); }

/* ============================
   Init & bindings
   ============================ */
document.getElementById('addNote').addEventListener('click', ()=>{
  const newNote = { text:'', x:120, y: toolbarHeight + 30, width:240, height:150, pinned:false, color:'bg-yellow-100' };
  data.pages[data.currentPage].push(newNote);
  saveAndRender();
});

document.getElementById('prevPage').addEventListener('click', ()=>{
  if(data.currentPage > 0){ data.currentPage--; saveAndRender(); }
});

document.getElementById('nextPage').addEventListener('click', ()=>{
  const cur = data.pages[data.currentPage] || [];
  if(cur.length < 5){ showMessage('–°–æ–∑–¥–∞–π—Ç–µ –º–∏–Ω–∏–º—É–º 5 –∑–∞–º–µ—Ç–æ–∫, –ø—Ä–µ–∂–¥–µ —á–µ–º –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç—å –¥–∞–ª—å—à–µ!'); return; }
  if(cur.some(n => !(n.text||'').trim())){ showMessage('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ, —á—Ç–æ–±—ã –≤ –∫–∞–∂–¥–æ–π –∑–∞–º–µ—Ç–∫–µ –±—ã–ª —Ç–µ–∫—Å—Ç!'); return; }
  if(data.currentPage === data.pages.length -1) data.pages.push([]);
  data.currentPage++; saveAndRender();
});

/* Search */
document.getElementById('search').addEventListener('input', (e)=> render(e.target.value.trim()));

/* Theme toggle */
const themeToggle = document.getElementById('themeToggle');
function applyTheme(isDark){
  if(isDark) document.documentElement.classList.add('dark'); else document.documentElement.classList.remove('dark');
  localStorage.setItem('notes_theme_dark', isDark ? '1' : '0');
}
themeToggle.addEventListener('click', ()=>{
  const isDark = !document.documentElement.classList.contains('dark');
  applyTheme(isDark);
});
applyTheme(localStorage.getItem('notes_theme_dark') === '1');

/* Export (downloads decoded JSON) */
document.getElementById('exportVisible').addEventListener('click', ()=>{
  const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'notes-export.json'; document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 3000);
});

/* Import */
document.getElementById('importBtn').addEventListener('click', ()=> document.getElementById('importFile').click());
document.getElementById('importFile').addEventListener('change', (ev)=>{
  const f = ev.target.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = (e)=>{
    try{
      const parsed = JSON.parse(e.target.result);
      // Basic sanity check: pages should be array
      if(!parsed.pages || !Array.isArray(parsed.pages)) { showMessage('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞'); return; }
      data = parsed;
      // save encoded
      saveData(data);
      render();
      showMessage('–ò–º–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à—ë–Ω');
    }catch(err){ showMessage('–û—à–∏–±–∫–∞ –∏–º–ø–æ—Ä—Ç–∞: –Ω–µ–≤–µ—Ä–Ω—ã–π JSON'); }
  };
  reader.readAsText(f);
});

/* On load render */
render();

/* Warn about file:// */
if(location.protocol === 'file:'){
  showMessage('–î–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã localStorage –æ—Ç–∫—Ä–æ–π—Ç–µ —Å–∞–π—Ç —á–µ—Ä–µ–∑ –ª–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –∏–ª–∏ GitHub Pages.', 6000);
}
</script>
</body>
</html>
